<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Convert images to XCS laser engraving files for stainless steel color engraving">
  <title>Picture Engraver by lasertools.org</title>
  <link rel="icon" type="image/png" href="./logo.png">
  <link rel="stylesheet" href="./style.css?v=layout_fix">
  <link rel="stylesheet" href="./onboarding.css">
</head>

<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <div class="logo-container">
          <img src="./logo.png" alt="Logo" class="app-logo">
        </div>
        <div class="title-container">
          <h1 class="title">Picture Engraver</h1>
          <span class="brand-subtitle">by lasertools.org</span>
        </div>
      </div>
      <div class="header-right">
        <button class="btn btn-icon" id="btnTestGrid" title="Test Grid Generator">
          <span>üìä</span>
          <span class="btn-label">Test Grid</span>
        </button>
        <button class="btn btn-icon" id="btnHelp" title="Tutorial">
          <span>‚ùì</span>
          <span class="btn-label">Help</span>
        </button>
        <button class="btn btn-icon" id="btnSettings" title="Settings">
          <span>‚öôÔ∏è</span>
          <span class="btn-label">Settings</span>
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main">
      <!-- Left Column: Upload & Controls -->
      <section class="panel upload-panel">
        <h2 class="panel-title">Image Upload</h2>

        <!-- Drop Zone -->
        <div class="drop-zone" id="dropZone">
          <div class="drop-zone-content">
            <span class="drop-zone-icon">üìÅ</span>
            <p class="drop-zone-text">Drop image here</p>
            <p class="drop-zone-subtext">or click to browse</p>
            <p class="drop-zone-formats">PNG, JPG, WebP</p>
          </div>
          <input type="file" id="fileInput" accept="image/png,image/jpeg,image/webp" hidden>
        </div>

        <!-- Image Preview (hidden until image loaded) -->
        <div class="image-preview-container" id="originalPreviewContainer" style="display: none;">
          <h3 class="preview-label">Original</h3>
          <div class="image-preview">
            <canvas id="originalCanvas"></canvas>
          </div>
          <button class="btn btn-secondary btn-sm" id="btnClearImage">‚úï Clear Image</button>
        </div>

        <!-- Controls -->
        <div class="controls" id="controlsSection" style="display: none;">
          <div class="control-group">
            <label class="control-label">Output Size</label>
            <select class="select" id="sizeSelect">
              <option value="100x100" selected>100 √ó 100 mm (Default)</option>
              <option value="200x200">200 √ó 200 mm</option>
              <option value="85x55">85 √ó 55 mm (Business Card)</option>
              <option value="custom">Custom...</option>
            </select>
          </div>

          <div class="control-group custom-size-group" id="customSizeGroup" style="display: none;">
            <div class="input-row">
              <div class="input-group">
                <label>Width (mm)</label>
                <input type="number" class="input" id="customWidth" value="100" min="10" max="200">
              </div>
              <span class="input-separator">√ó</span>
              <div class="input-group">
                <label>Height (mm)</label>
                <input type="number" class="input" id="customHeight" value="100" min="10" max="200">
              </div>
            </div>
          </div>

          <div class="control-group" style="gap: 10px;">
            <label class="control-label">
              Number of Colors: <span class="value-display" id="colorCountDisplay">8</span>
            </label>
            <input type="range" class="slider" id="colorSlider" min="2" max="32" value="8">
          </div>

          <button class="btn btn-primary" id="btnProcess" style="margin-top: 15px;">
            <span>üîÑ</span> Process Image
          </button>
          <div style="margin-top: 5px; font-size: 0.75em; color: #888; text-align: center;">
            v2.0.0
          </div>
        </div>
      </section>

      <!-- Center Column: Layers -->
      <section class="panel layers-panel" id="layersPanel" style="display: none;">
        <h2 class="panel-title">Color Layers</h2>

        <div class="layers-list" id="layersList">
          <!-- Layers will be populated dynamically -->
        </div>

        <div class="layers-actions">
          <button class="btn btn-secondary" id="btnAutoAssign">
            <span>üéØ</span> Auto-Assign Colors
          </button>
          <div id="calibrationStatus" class="calibration-status"
            style="font-size: 0.85em; color: var(--text-tertiary);">
            <!-- Will be populated dynamically -->
          </div>
        </div>

        <!-- Calibration Preview -->
        <div id="layerCalibrationPreview"
          style="display: none; border-top: 1px solid var(--border-primary); padding-top: 15px;">
          <h3 class="preview-label" style="font-size: 0.75em; margin-bottom: 8px;">Source Calibration</h3>
          <div
            style="position: relative; background: #000; border-radius: 8px; overflow: hidden; border: 1px solid var(--border-primary); max-height: 200px;">
            <canvas id="layerCalibrationCanvas" style="width: 100%; height: auto; display: block;"></canvas>
          </div>
          <div id="layerCalibrationText"
            style="font-size: 0.8em; color: var(--text-secondary); margin-top: 5px; text-align: center;"></div>
        </div>
      </section>

      <!-- Right Column: Preview & Export -->
      <section class="panel preview-panel" id="previewPanel" style="display: none;">
        <h2 class="panel-title">Preview</h2>

        <div class="preview-tabs">
          <button class="tab active" data-tab="quantized">Quantized</button>
          <button class="tab" data-tab="vectors">Vectors</button>
        </div>

        <div class="preview-content">
          <div class="image-preview" id="previewQuantized">
            <canvas id="quantizedCanvas"></canvas>
          </div>
          <div class="image-preview" id="previewVectors" style="display: none;">
          </div>
        </div>

        <div class="export-actions">
          <div class="focus-warning focus-warning-block"
            style="color: #ff4d4f; background: rgba(255, 77, 79, 0.1); border: 1px solid rgba(255, 77, 79, 0.2); padding: 10px; border-radius: 8px; text-align: center; font-size: 0.95em;">
            <strong>‚ö†Ô∏è Important:</strong> Manually change focus <u style="font-weight: bold;">UP by 4mm</u> for best
            results!
          </div>
          <button class="btn btn-success btn-lg" id="btnDownloadXCS">
            <span>üíæ</span> Download XCS
          </button>
        </div>
      </section>
    </main>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h2>Settings</h2>
          <button class="btn btn-icon modal-close" id="closeSettingsModal">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="setting-group">
            <h3>Default Engraving Settings</h3>
            <div class="setting-row">
              <label>Power (%)</label>
              <input type="number" class="input" id="settingPower" value="70" min="1" max="100">
            </div>
            <div class="setting-row">
              <label>Speed (mm/s)</label>
              <input type="number" class="input" id="settingSpeed" value="425" min="1" max="1000">
            </div>
            <div class="setting-row">
              <label>Passes</label>
              <input type="number" class="input" id="settingPasses" value="1" min="1" max="10">
            </div>
            <div class="setting-row">
              <label>Cross Hatch</label>
              <input type="checkbox" class="checkbox" id="settingCrossHatch" checked>
            </div>
            <div class="setting-row" id="rowPulseWidth">
              <label>Pulse Width (ns)</label>
              <input type="number" class="input" id="settingPulseWidth" value="80" min="1">
            </div>
          </div>



          <div class="setting-group">
            <h3>Frequency Range (kHz)</h3>
            <div class="setting-row">
              <label>Min</label>
              <input type="number" class="input" id="settingFreqMin" value="40" min="20" max="100">
            </div>
            <div class="setting-row">
              <label>Max</label>
              <input type="number" class="input" id="settingFreqMax" value="80" min="20" max="100">
            </div>
          </div>

          <div class="setting-group">
            <h3>Lines/cm Range (LPC)</h3>
            <div class="setting-row">
              <label>Min</label>
              <input type="number" class="input" id="settingLpiMin" value="300" min="100" max="1000">
            </div>
            <div class="setting-row">
              <label>Max</label>
              <input type="number" class="input" id="settingLpiMax" value="800" min="100" max="1000">
            </div>
          </div>

          <div class="setting-group">
            <h3>Standard Colors (Black & White)</h3>
            <div class="setting-row">
              <label><strong>Black Layer</strong></label>
            </div>
            <div class="setting-row">
              <label>Freq (kHz)</label>
              <input type="number" class="input" id="settingBlackFreq" value="40" min="20" max="150">
            </div>
            <div class="setting-row">
              <label>Lines/cm</label>
              <input type="number" class="input" id="settingBlackLpi" value="300" min="10" max="1000">
            </div>
            <div class="setting-row">
              <label>Speed (mm/s)</label>
              <input type="number" class="input" id="settingBlackSpeed" value="425" min="1" max="1000">
            </div>
            <div class="setting-row">
              <label>Power (%)</label>
              <input type="number" class="input" id="settingBlackPower" value="70" min="1" max="100">
            </div>

            <div class="setting-row" style="margin-top: 15px;">
              <label><strong>White Layer</strong></label>
            </div>
            <div class="setting-row">
              <label>Freq (kHz)</label>
              <input type="number" class="input" id="settingWhiteFreq" value="40" min="20" max="150">
            </div>
            <div class="setting-row">
              <label>Lines/cm</label>
              <input type="number" class="input" id="settingWhiteLpi" value="300" min="10" max="1000">
            </div>
            <div class="setting-row">
              <label>Speed (mm/s)</label>
              <input type="number" class="input" id="settingWhiteSpeed" value="425" min="1" max="1000">
            </div>
            <div class="setting-row">
              <label>Power (%)</label>
              <input type="number" class="input" id="settingWhitePower" value="70" min="1" max="100">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="btnResetSettings">Reset to Defaults</button>
          <button class="btn btn-primary" id="btnSaveSettings">Save Settings</button>
        </div>
      </div>
    </div>

    <!-- Test Grid Modal -->
    <div class="modal" id="testGridModal">
      <div class="modal-backdrop"></div>
      <div class="modal-content modal-xl">
        <div class="modal-header">
          <h2>Test Grid Calibration</h2>
          <button class="btn btn-icon modal-close" id="closeTestGridModal">‚úï</button>
        </div>
        <div class="modal-body">
          <!-- Tabs -->
          <div class="modal-tabs">
            <button class="modal-tab active" data-modal-tab="standard">üèÜ Standard Grid</button>
            <button class="modal-tab" data-modal-tab="custom">‚öôÔ∏è Custom Grid</button>
            <button class="modal-tab" data-modal-tab="analyzer">üì∑ Analyze Grid</button>
          </div>

          <!-- Standard Grid Tab -->
          <div class="modal-tab-content active" id="tabStandard">
            <div class="standard-grid-layout">
              <div class="standard-grid-details">
                <h3>Optimized Business Card Grid</h3>
                <p>The perfect starting point for stainless steel color engraving.</p>

                <div class="focus-warning-block"
                  style="background-color: #fff3cd; color: #856404; padding: 12px; border-radius: 6px; margin: 15px 0; border: 1px solid #ffeeba;">
                  <p style="margin: 0;">
                    <strong style="font-size: 1.1em; margin-right: 5px;">‚ö†Ô∏è Important:</strong>
                    Manually adjust the laser focus <strong>UP by 4mm</strong> to achieve the best color results.
                  </p>
                </div>

                <ul class="feature-list">
                  <li id="stdGridFormat"><strong>Format:</strong> 85mm √ó 55mm (Business Card)</li>
                  <li id="stdGridPoints"><strong>Density:</strong> 122 Test Points (14 √ó 9 Grid)</li>
                  <li id="stdGridVar1"><strong>Frequency:</strong> 40kHz - 90kHz (Optimized range)</li>
                  <li id="stdGridVar2"><strong>Lines/cm:</strong> 800 - 300 (High to Low)</li>
                  <li id="stdGridPasses"><strong>Passes:</strong> 1</li>
                  <li id="stdGridQR"><strong>Smart QR:</strong> Located at bottom-right, scanned for auto-settings.</li>
                </ul>
              </div>

              <div class="standard-grid-preview-panel">
                <div class="standard-preview-static" style="display: flex; justify-content: center; margin: 0;">
                  <canvas id="standardPreviewCanvas"></canvas>
                </div>

                <div class="action-row" style="text-align: right; margin-top: auto;">
                  <a href="#" class="btn btn-primary btn-lg" id="btnGenerateStandard" style="width: 100%;">
                    <span>üíæ</span> Download Standard XCS
                  </a>
                </div>
              </div>
            </div>
          </div>

          <!-- Custom Grid Tab -->
          <div class="modal-tab-content" id="tabCustom">
            <p class="modal-description">
              Create a custom calibration grid with your specific limits and dimensions.
            </p>

            <div class="focus-warning-block"
              style="background-color: #fff3cd; color: #856404; padding: 12px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #ffeeba;">
              <p style="margin: 0;">
                <strong style="font-size: 1.1em; margin-right: 5px;">‚ö†Ô∏è Important:</strong>
                Manually adjust the laser focus <strong>UP by 4mm</strong> to achieve the best color results.
              </p>
            </div>

            <div class="custom-grid-layout">

              <div class="custom-grid-settings-panel">
                <!-- MOPA Control: Fixed Parameter Selection -->
                <div class="setting-group" id="mopaFixedControl" style="display:none;">
                  <h3>Fixed Parameter</h3>
                  <select class="input" id="gridFixedParam">
                    <option value="frequency">Fixed Frequency (Vary Speed & Power)</option>
                    <option value="power">Fixed Power (Vary Speed & Freq)</option>
                    <option value="speed">Fixed Speed (Vary Power & Freq)</option>
                  </select>
                </div>

                <div class="grid-settings-columns">
                  <!-- Frequency Settings (Axis 1 or Fixed) -->
                  <div class="setting-group" id="groupFreq">
                    <h3 id="gridHeaderFreq">Frequency (kHz)</h3>
                    <!-- Range Inputs -->
                    <div id="cntFreqRange" class="range-inputs-row">
                      <div class="setting-row">
                        <label>Min</label>
                        <input type="number" class="input" id="gridFreqMin" value="40" min="1" max="4000">
                      </div>
                      <div class="setting-row">
                        <label>Max</label>
                        <input type="number" class="input" id="gridFreqMax" value="90" min="1" max="4000">
                      </div>
                    </div>
                    <!-- Fixed Input (Hidden by default) -->
                    <div class="setting-row" id="cntFreqFixed" style="display:none">
                      <label>Value</label>
                      <input type="number" class="input" id="gridFreqFixed" value="40" min="1" max="4000">
                    </div>
                  </div>

                  <!-- LPC Settings -->
                  <div class="setting-group" id="groupLpi">
                    <h3 id="gridHeaderLPI">Lines/cm (LPC)</h3>
                    <!-- Range Inputs (UV) -->
                    <div id="cntLpiRange" class="range-inputs-row">
                      <div class="setting-row">
                        <label>Min</label>
                        <input type="number" class="input" id="gridLpiMin" value="300" min="10" max="5000">
                      </div>
                      <div class="setting-row">
                        <label>Max</label>
                        <input type="number" class="input" id="gridLpiMax" value="800" min="10" max="5000">
                      </div>
                    </div>
                    <!-- Fixed Input (MOPA) -->
                    <div class="setting-row" id="cntLpiFixed" style="display:none">
                      <label>Value</label>
                      <input type="number" class="input" id="gridLpiFixed" value="1000" min="10" max="5000">
                    </div>
                  </div>

                  <!-- Grid Layout -->
                  <div class="setting-group">
                    <h3>Grid Layout</h3>
                    <div class="setting-row">
                      <label>Cell Size (mm)</label>
                      <input type="number" class="input" id="gridCellSize" value="5" min="1" max="10">
                    </div>
                    <div class="setting-row">
                      <label>Cell Gap (mm)</label>
                      <input type="number" class="input" id="gridCellGap" value="1" min="0" max="5" step="0.5">
                    </div>
                  </div>

                  <!-- Engraving / Power / Speed Settings -->
                  <div class="setting-group" id="groupEngraving">
                    <h3 id="gridHeaderEngraving">Parameters</h3>

                    <!-- Power -->
                    <div id="subGroupPower">
                      <!-- Single -->
                      <div class="setting-row" id="cntPowerFixed">
                        <label id="gridLabelPower">Power (%)</label>
                        <input type="number" class="input" id="gridPower" value="70" min="1" max="100">
                      </div>
                      <!-- Range (Hidden default) -->
                      <div id="cntPowerRange" class="range-inputs-row" style="display:none">
                        <label class="range-label">Power Range (%)</label>
                        <div class="setting-row">
                          <label>Min</label>
                          <input type="number" class="input" id="gridPowerMin" value="10" min="1" max="100">
                        </div>
                        <div class="setting-row">
                          <label>Max</label>
                          <input type="number" class="input" id="gridPowerMax" value="20" min="1" max="100">
                        </div>
                      </div>
                    </div>

                    <!-- Speed -->
                    <div id="subGroupSpeed">
                      <!-- Single -->
                      <div class="setting-row" id="cntSpeedFixed">
                        <label id="gridLabelSpeed">Speed (mm/s)</label>
                        <input type="number" class="input" id="gridSpeed" value="425" min="1" max="4000">
                      </div>
                      <!-- Range (Hidden default) -->
                      <div id="cntSpeedRange" class="range-inputs-row" style="display:none">
                        <label class="range-label">Speed Range (mm/s)</label>
                        <div class="setting-row">
                          <label>Min</label>
                          <input type="number" class="input" id="gridSpeedMin" value="200" min="1" max="4000">
                        </div>
                        <div class="setting-row">
                          <label>Max</label>
                          <input type="number" class="input" id="gridSpeedMax" value="1500" min="1" max="4000">
                        </div>
                      </div>
                    </div>

                    <div class="setting-row">
                      <label>Passes</label>
                      <input type="number" class="input" id="gridPasses" value="1" min="1" max="10">
                    </div>
                    <div class="setting-row">
                      <label>Cross Hatch</label>
                      <input type="checkbox" class="checkbox" id="gridCrossHatch" checked>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Right Column: Preview & Actions -->
              <div class="custom-grid-preview-panel">
                <!-- Grid Info -->
                <div class="grid-info" id="gridInfo">
                  <p><strong>Size:</strong> <span id="gridInfoSize">14 √ó 9</span> cells</p>
                  <p><strong>Points:</strong> <span id="gridInfoCells">122</span></p>
                </div>

                <!-- Preview -->
                <div class="grid-preview" id="gridPreviewContainer">
                  <canvas id="gridPreviewCanvas"></canvas>
                </div>

                <!-- Custom Actions -->
                <div class="modal-footer-custom"
                  style="display: flex; justify-content: flex-end; gap: 10px; margin-top: auto;">
                  <button class="btn btn-secondary" id="btnPreviewGrid">Update Preview</button>
                  <button class="btn btn-primary" id="btnGenerateGrid">
                    <span>üíæ</span> Download Custom XCS
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Analyzer Tab -->
          <div class="modal-tab-content" id="tabAnalyzer">
            <p class="modal-description">
              Upload a photo of your engraved test grid. The app will read the QR code
              to identify settings and map colors to laser parameters.
            </p>

            <!-- Upload Zone -->
            <div class="drop-zone analyzer-drop-zone" id="analyzerDropZone">
              <div class="drop-zone-content">
                <span class="drop-zone-icon">üì∑</span>
                <p class="drop-zone-text">Drop test grid photo here</p>
                <p class="drop-zone-subtext">or click to browse</p>
              </div>
              <input type="file" id="analyzerFileInput" accept="image/*" hidden>
            </div>

            <!-- Analysis Preview -->
            <div class="analysis-preview" id="analysisPreview" style="display: none;">
              <div class="analysis-visualization"
                style="flex: 1; max-width: 50%; display: flex; flex-direction: column; gap: 10px;">
                <div class="analysis-image" style="max-width: 100%; width: 100%; flex: 0 0 auto; position: relative;">
                  <canvas id="analyzerCanvas" style="cursor: pointer;"></canvas>
                  <div id="analyzerClickOverlay"
                    style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); pointer-events: none; opacity: 1; transition: opacity 0.2s;">
                    <div style="text-align: center; color: #fff;">
                      <div style="font-size: 32px; margin-bottom: 8px;">üñ±Ô∏è</div>
                      <div style="font-size: 14px; font-weight: 500;">Click to Align Grid</div>
                      <div style="font-size: 12px; opacity: 0.7; margin-top: 4px;">Opens fullscreen view</div>
                    </div>
                  </div>
                </div>
                <div class="analysis-toolbar" style="display: flex; justify-content: center; gap: 10px;">
                  <button id="btnRotateAnalyzer" class="btn btn-secondary btn-sm" title="Rotate Image 90¬∞">üîÑ
                    Rotate</button>
                  <button id="btnClearAnalyzer" class="btn btn-secondary btn-sm" title="Clear image and reset">üóëÔ∏è Clear
                    Image</button>
                </div>
              </div>
              <div class="analysis-info">
                <h3>Detected Settings</h3>
                <div id="analysisSettings">
                  <p class="text-muted">Upload a grid photo to analyze...</p>
                </div>
                <div id="analyzerFallback"
                  style="display: none; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
                  <p class="text-muted" style="font-size: 0.9em; margin-bottom: 15px;">
                    Can't read the QR code? You can use the default settings or enter them manually:
                  </p>

                  <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                    <button class="btn btn-secondary btn-sm" id="btnUseDefaultGrid" style="flex: 1;">
                      üéØ Use Default Settings
                    </button>
                    <button class="btn btn-outline btn-sm" id="btnToggleManualSettings" style="flex: 1;">
                      ‚öôÔ∏è Manual Input
                    </button>
                  </div>

                  <!-- Manual Settings Panel -->
                  <div id="manualSettingsPanel" style="display: none;">
                    <div class="grid-settings-columns" style="margin-bottom: 15px;">

                      <!-- Grid Layout -->
                      <div class="setting-group">
                        <h3>Grid Layout</h3>
                        <div class="setting-row">
                          <label>Columns</label>
                          <input type="number" class="input" id="manualCols" value="14" min="1">
                        </div>
                        <div class="setting-row">
                          <label>Rows</label>
                          <input type="number" class="input" id="manualRows" value="9" min="1">
                        </div>
                      </div>

                      <!-- Frequency Range -->
                      <div class="setting-group">
                        <h3>Frequency (kHz)</h3>
                        <div class="setting-row">
                          <label>Min</label>
                          <input type="number" class="input" id="manualFreqMin" value="40">
                        </div>
                        <div class="setting-row">
                          <label>Max</label>
                          <input type="number" class="input" id="manualFreqMax" value="80">
                        </div>
                      </div>

                      <!-- LPC Range -->
                      <div class="setting-group">
                        <h3>Lines/cm</h3>
                        <div class="setting-row">
                          <label>Min</label>
                          <input type="number" class="input" id="manualLpiMin" value="200">
                        </div>
                        <div class="setting-row">
                          <label>Max</label>
                          <input type="number" class="input" id="manualLpiMax" value="300">
                        </div>
                      </div>
                    </div>

                    <button id="btnApplyManualSettings" class="btn btn-primary" style="width: 100%;">
                      Apply Settings & Enable Alignment
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Color Map -->
            <div class="color-map" id="colorMapSection" style="display: none;">
              <div class="color-map-header"
                style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <div>
                  <h3 style="margin: 0;">Step 2: Map Colors</h3>
                  <p class="modal-description" style="margin: 5px 0 0 0;">
                    Click a cell below to capture its color and see settings.
                  </p>
                </div>
                <div id="activeSelectionBox" class="selection-detail-box"
                  style="background: var(--bg-panel); border: 1px solid var(--border-color); padding: 8px 15px; border-radius: 8px; min-width: 200px; display: none;">
                  <div
                    style="font-size: 0.8em; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px;">
                    Selected Settings</div>
                  <div id="activeSelectionText"
                    style="font-weight: 600; font-size: 1.1em; color: var(--primary-color);">
                    40kHz / 800 LPC</div>
                </div>
              </div>

              <div id="alignmentHint"
                style="background: #e7f3ff; color: #004085; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 0.9em; display: none;">
                üí° <strong>Tip:</strong> If the colors look wrong, try to click the 4 corners of the card in the image
                above to re-align the grid.
              </div>
              <div class="color-map-grid" id="colorMapGrid">
                <!-- Will be populated dynamically -->
              </div>

              <!-- Save Color Map Button -->
              <div id="saveColorMapSection" class="color-map-actions"
                style="display: none; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-primary);">
                <div style="display: flex; gap: 10px; align-items: center;">
                  <button class="btn btn-success btn-lg" id="btnSaveColorMap" style="flex: 1;">
                    <span>üíæ</span> Save Color Map
                  </button>
                  <button class="btn btn-secondary btn-lg" id="btnAdvancedAnalyzer"
                    title="Open Advanced Editor with side-by-side view">
                    <span>üî¨</span> Advanced Editor
                  </button>
                </div>
                <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 10px; text-align: center;">
                  Saving will store these calibrated colors for use with the Auto-Assign feature.
                </p>
                <div id="savedColorMapStatus"
                  style="display: none; margin-top: 10px; padding: 10px; background: rgba(63, 185, 80, 0.1); border: 1px solid var(--accent-success); border-radius: 6px; text-align: center;">
                  ‚úÖ <strong>Color map saved!</strong> You can now use Auto-Assign Colors when processing images.
                </div>
              </div>
            </div>

            <!-- Color Grids Section (consolidated) -->
            <div class="color-grids-section" id="colorGridsSection"
              style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-primary);">

              <!-- Header with stats -->
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                <div>
                  <h3 style="margin: 0;">Color Grids</h3>
                  <p class="modal-description" style="margin: 5px 0 0 0;">
                    Active grids are merged for Auto-Assign. Toggle to enable/disable.
                  </p>
                </div>
                <div id="gridStatsSummary"
                  style="background: var(--bg-tertiary); padding: 8px 12px; border-radius: 6px; font-size: 0.85em; text-align: right;">
                  <span id="gridStatsText">Loading...</span>
                </div>
              </div>

              <!-- Grid list with toggles -->
              <div id="colorGridsList" class="color-grids-list"
                style="display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto; margin-bottom: 12px;">
                <!-- Populated by JS -->
              </div>

              <!-- Actions: Import/Export only -->
              <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary btn-sm" id="btnExportGrids" style="flex: 1;">
                  <span>üì§</span> Export Grids
                </button>
                <button class="btn btn-secondary btn-sm" id="btnImportGrids" style="flex: 1;">
                  <span>üì•</span> Import Grids
                </button>
                <input type="file" id="gridImportFileInput" accept=".json" hidden>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Advanced Analyzer Modal -->
    <div class="modal" id="advancedAnalyzerModal">
      <div class="modal-backdrop"></div>
      <div class="modal-content modal-fullscreen">
        <div class="modal-header">
          <h2>üî¨ Advanced Color Editor</h2>
          <button class="btn btn-icon modal-close" id="closeAdvancedAnalyzer">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="analyzer-split-view">
            <!-- Left: Source Photo -->
            <div class="analyzer-source-panel">
              <h4>üì∑ Source Photo</h4>
              <p class="panel-hint">Click on a color in the grid to highlight it here</p>
              <div class="analyzer-source-canvas-container">
                <canvas id="advancedAnalyzerCanvas"></canvas>
              </div>
            </div>

            <!-- Right: Detected Grid with editing -->
            <div class="analyzer-grid-panel">
              <h4>üé® Detected Colors</h4>

              <!-- Similar colors warning -->
              <div id="similarColorsPanel" class="similar-colors-panel" style="display: none !important;">
                <div class="similar-colors-header">
                  <span>‚ö†Ô∏è Similar Colors Detected</span>
                  <button class="btn btn-sm btn-secondary" id="btnShowSimilar">Show Details</button>
                </div>
                <div id="similarColorsList" class="similar-colors-list" style="display: none;"></div>
              </div>

              <!-- Color grid -->
              <div id="advancedColorGrid" class="color-map-grid advanced-grid"></div>

              <!-- Color detail panel -->
              <div id="colorDetailPanel" class="color-detail-panel" style="display: none;">
                <div class="color-detail-preview">
                  <div id="colorDetailSwatch" class="color-swatch"></div>
                  <div class="color-detail-info">
                    <span id="colorDetailSettings">-- kHz / -- LPC</span>
                    <span id="colorDetailPosition">Row --, Col --</span>
                  </div>
                </div>
                <div class="color-detail-actions">
                  <input type="text" id="colorNameInput" class="input" placeholder="Custom name (optional)">
                  <button class="btn btn-danger btn-sm" id="btnDeleteColor" style="display: none;">üóëÔ∏è Remove</button>
                  <button class="btn btn-secondary btn-sm" id="btnRestoreColor" style="display: none;">‚Ü©Ô∏è
                    Restore</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <div class="advanced-footer-stats">
            <span id="advancedColorCount">0 colors</span>
            <span id="advancedExcludedCount">0 excluded</span>
          </div>
          <button class="btn btn-secondary" id="btnCancelAdvanced">Cancel</button>
          <button class="btn btn-success" id="btnSaveAdvanced">
            <span>üíæ</span> Save Color Map
          </button>
        </div>
      </div>
    </div>

    <!-- Layer Edit Modal -->
    <div class="modal" id="layerEditModal">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h2>Edit Layer</h2>
          <button class="btn btn-icon modal-close" id="closeLayerEditModal">‚úï</button>
        </div>
        <div class="modal-body">
          <!-- Manual Settings -->
          <div class="setting-group">
            <h3>Layer Settings</h3>
            <div class="setting-row">
              <label>Name</label>
              <input type="text" class="input" id="layerEditName">
            </div>
            <div class="setting-row">
              <label>Frequency (kHz)</label>
              <input type="number" class="input" id="layerEditFreq" min="20" max="150">
            </div>
            <div class="setting-row">
              <label>Lines/cm</label>
              <input type="number" class="input" id="layerEditLpi" min="10" max="1000">
            </div>
            <div class="setting-row">
              <label>Speed (mm/s)</label>
              <input type="number" class="input" id="layerEditSpeed" min="1" max="1000">
            </div>
            <div class="setting-row">
              <label>Power (%)</label>
              <input type="number" class="input" id="layerEditPower" min="1" max="100">
            </div>
          </div>

          <!-- Color Picker from Calibration -->
          <div class="setting-group">
            <h3>Pick from Calibrated Colors</h3>
            <p class="modal-description" style="margin-top: 0; margin-bottom: 10px;">
              Select a color from your test grid to apply its settings.
            </p>
            <div class="layer-edit-calibration-container" style="display: flex; gap: 15px; margin-top: 10px;">
              <div id="layerEditColorGrid" class="color-map-grid" style="flex: 1; max-height: 250px; overflow-y: auto;">
                <!-- Populated dynamically -->
                <p class="text-muted" style="text-align: center; padding: 20px;">No calibration data available.</p>
              </div>
              <div id="layerEditSourcePreview" style="flex: 1; display: none; flex-direction: column; gap: 5px;">
                <span class="preview-label" style="font-size: 0.75em;">Source Grid Spot</span>
                <div
                  style="position: relative; background: #000; border-radius: 4px; overflow: hidden; border: 1px solid var(--border-primary);">
                  <canvas id="layerEditSourceCanvas" style="width: 100%; height: auto; display: block;"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="btnCancelLayerEdit">Cancel</button>
          <button class="btn btn-primary" id="btnSaveLayerEdit">Save Changes</button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-left">
        &copy; 2026 Thomas Winnerl
        <a href="https://github.com/Pixelplanet/picture-engraver" target="_blank" rel="noopener">GitHub</a>
        <a href="./privacy.html">Datenschutz</a>
        <a href="./privacy-en.html">Privacy Policy</a>
      </div>
      <div class="footer-right">
        <span class="donate-label">Help keep this website running:</span>
        <a href="https://www.paypal.com/donate/?hosted_button_id=KSPSCWTMFXSR4" target="_blank" class="donate-link">
          <span>‚ù§Ô∏è</span> Donate via PayPal
        </a>
      </div>
    </footer>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Lightbox Modal -->
    <div class="lightbox-modal" id="lightboxModal">
      <button class="lightbox-close" id="closeLightbox">&times;</button>
      <div class="lightbox-content" id="lightboxContent"></div>
    </div>

    <!-- Fullscreen Grid Alignment Modal -->
    <div class="alignment-modal" id="alignmentModal"
      style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; flex-direction: column;">
      <div class="alignment-header"
        style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: rgba(0,0,0,0.8); border-bottom: 1px solid #333;">
        <div style="display: flex; align-items: center; gap: 20px;">
          <h2 style="margin: 0; color: #fff; font-size: 20px;">üìê Grid Alignment</h2>
          <span id="alignmentStatus" style="color: #ffd700; font-size: 16px; font-weight: 500;">Click the 4 corners of
            the COLOR GRID</span>
        </div>
        <div style="display: flex; gap: 10px;">
          <button id="btnResetCorners" class="btn btn-secondary" style="padding: 8px 16px;">üîÑ Reset Corners</button>
          <button id="btnApplyAlignment" class="btn btn-primary" style="padding: 8px 16px; display: none;">‚úì Apply
            Alignment</button>
          <button id="btnCloseAlignment" class="btn btn-ghost" style="padding: 8px 16px;">‚úï Cancel</button>
        </div>
      </div>
      <div class="alignment-body"
        style="flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px; overflow: hidden;">
        <canvas id="alignmentCanvas"
          style="max-width: 100%; max-height: 100%; cursor: crosshair; border: 2px solid #444; border-radius: 8px;"></canvas>
      </div>
      <div class="alignment-footer" id="alignmentFooter"
        style="display: none; padding: 15px 20px; background: rgba(0,0,0,0.8); border-top: 1px solid #333; text-align: center;">
        <span style="color: #00d4ff; font-size: 16px;">
          <strong>Selected Corner:</strong> <span id="selectedCornerLabel">-</span> &nbsp;|&nbsp;
          <strong>‚Üë‚Üì‚Üê‚Üí</strong> Move (Shift: faster) &nbsp;|&nbsp;
          <strong>Tab</strong> Next Corner &nbsp;|&nbsp;
          <strong>Enter</strong> Apply &nbsp;|&nbsp;
          <strong>Esc</strong> Done
        </span>
      </div>
    </div>

    <!-- Merge Layers Modal -->
    <div id="mergeModal" class="modal">
      <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
          <h2 class="modal-title">Merge Layers</h2>
          <span class="modal-close" id="closeMergeModal">&times;</span>
        </div>
        <div class="modal-body">
          <p style="margin-bottom: 15px; color: var(--text-secondary); font-size: 0.9em;">
            Multiple layers have the same laser settings. Select which groups you want to merge:
          </p>
          <div id="mergeSuggestionsList" class="merge-suggestions-list">
            <!-- Injected by JS -->
          </div>
        </div>
        <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
          <button class="btn btn-secondary" id="btnCancelMerge">Cancel</button>
          <button class="btn btn-primary" id="btnConfirmMerge">Merge Selected</button>
        </div>
      </div>
    </div>

    <!-- Mini Color Picker Popup -->
    <div id="miniColorPicker" class="mini-picker">
      <div class="mini-picker-header">
        <h4>Pick Color from Grid</h4>
        <span class="mini-picker-close" id="closeMiniPicker">&times;</span>
      </div>
      <div class="mini-picker-content">
        <div class="mini-picker-canvas-container">
          <canvas id="miniPickerCanvas" class="mini-picker-canvas"></canvas>
          <!-- Zoom controls overlay -->
          <div class="mini-picker-zoom-controls">
            <button id="btnZoomOut" class="zoom-btn" title="Zoom Out">‚àí</button>
            <button id="btnZoomReset" class="zoom-btn zoom-reset" title="Reset Zoom">‚§¢</button>
            <button id="btnZoomIn" class="zoom-btn" title="Zoom In">+</button>
          </div>
        </div>
      </div>
      <div id="miniPickerFooter" class="mini-picker-footer" style="flex-direction: column; gap: 8px;">
        <div class="picker-navigation"
          style="display: flex; justify-content: space-between; align-items: center; width: 100%; gap: 8px;">
          <label style="font-size: 0.8em; color: var(--text-secondary); white-space: nowrap;">Grid:</label>
          <select id="miniPickerGridSelect" class="grid-dropdown"
            style="flex: 1; padding: 4px 8px; font-size: 0.85em; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary); border-radius: var(--radius-sm); cursor: pointer;">
            <!-- Options populated by JS -->
          </select>
          <!-- Keep prev/next as secondary option for keyboard users -->
          <button id="btnPrevGrid" class="btn btn-sm btn-secondary" title="Previous Grid (‚Üê)"
            style="padding: 2px 8px; display: none;">‚óÄ</button>
          <button id="btnNextGrid" class="btn btn-sm btn-secondary" title="Next Grid (‚Üí)"
            style="padding: 2px 8px; display: none;">‚ñ∂</button>
        </div>

        <!-- View Options -->
        <div class="picker-options" style="display: flex; align-items: center; gap: 8px; padding: 0 4px;">
          <label class="checkbox-label"
            style="font-size: 0.8em; color: var(--text-secondary); display: flex; align-items: center; gap: 6px; cursor: pointer;">
            <input type="checkbox" id="cbShowGridLines">
            Show Grid Lines
          </label>
        </div>

        <div style="display: flex; justify-content: space-between; width: 100%;">
          <span id="miniPickerCoords">Col: - Row: -</span>
          <span id="miniPickerValues">F: - LPC: -</span>
        </div>
        <div id="miniPickerHint" style="font-size: 0.75em; color: var(--text-tertiary); text-align: center;">
          Scroll to zoom ‚Ä¢ Click to select
        </div>
      </div>
    </div>

    <!-- Status Bar -->
    <div id="statusBar" class="status-bar"
      style="position: fixed; bottom: 0; left: 0; right: 0; background: #2d2d2d; color: #fff; padding: 8px 15px; font-size: 0.9em; display: none; z-index: 1000; border-top: 1px solid #444; align-items: center; justify-content: space-between;">
      <span id="statusText">Ready</span>
      <div id="progressContainer"
        style="width: 200px; height: 6px; background: #444; border-radius: 3px; overflow: hidden; display: none;">
        <div id="progressFill" style="width: 0%; height: 100%; background: #4a90e2; transition: width 0.3s;"></div>
      </div>
    </div>
  </div>

  <!-- Device Selection Overlay -->
  <div id="deviceSelectionOverlay"
    style="position: fixed; inset: 0; background: #1a1a1a; z-index: 20000; display: none; align-items: center; justify-content: center; flex-direction: column;">
    <!-- Content injected by JS -->
  </div>

  <script type="module" src="./main.js?v=layout_fix"></script>

</body>

</html>